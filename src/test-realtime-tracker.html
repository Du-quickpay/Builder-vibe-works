<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>آزمایش Real-time Tracker</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        direction: rtl;
        text-align: right;
        background: #f5f7fa;
      }

      .container {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .status {
        font-size: 24px;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        font-weight: bold;
      }

      .online {
        background: #d4edda;
        color: #155724;
        border: 2px solid #c3e6cb;
      }

      .offline {
        background: #f8d7da;
        color: #721c24;
        border: 2px solid #f5c6cb;
      }

      .inactive {
        background: #fff3cd;
        color: #856404;
        border: 2px solid #ffeaa7;
      }

      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }

      .logs {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }

      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-radius: 4px;
      }

      .log-online {
        background: #d4edda;
      }

      .log-offline {
        background: #f8d7da;
      }

      .log-change {
        background: #fff3cd;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }

      button:hover {
        background: #0056b3;
      }

      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .stat {
        background: #e9ecef;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #495057;
      }

      .stat-label {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <h1>🧪 آزمایش سیستم Real-time Online/Offline</h1>

    <div class="info">
      <h3>📝 راهنمای آزمایش</h3>
      <p>
        این صفحه برای تست سیستم تشخیص آنلاین/آفلاین بودن کاربر طراحی شده. عملیات
        زیر را انجام دهید:
      </p>
      <ul>
        <li>🔄 صفحه را reload کنید</li>
        <li>🔁 تب را عوض کنید</li>
        <li>❌ صفحه را ببندید</li>
        <li>📡 اینترنت را قطع/وصل کنید</li>
        <li>👆 روی صفحه کلیک کنید یا حرکت دهید</li>
      </ul>
    </div>

    <div class="grid">
      <div class="container">
        <h3>📊 وضعیت فعلی</h3>

        <div id="currentStatus" class="status offline">
          ❓ در حال بارگذاری...
        </div>

        <div class="stats">
          <div class="stat">
            <div id="onlineTime" class="stat-value">0</div>
            <div class="stat-label">ثانیه آنلاین</div>
          </div>
          <div class="stat">
            <div id="offlineTime" class="stat-value">0</div>
            <div class="stat-label">ثانیه آفلاین</div>
          </div>
          <div class="stat">
            <div id="totalSwitches" class="stat-value">0</div>
            <div class="stat-label">تعداد تغییرات</div>
          </div>
          <div class="stat">
            <div id="lastUpdate" class="stat-value">-</div>
            <div class="stat-label">آخرین به‌روزرسانی</div>
          </div>
        </div>

        <div>
          <h4>جزئیات وضعیت:</h4>
          <p id="detailStatus">در حال بارگذاری...</p>
        </div>

        <div>
          <button id="startBtn" onclick="startTracking()">
            🚀 شروع ردیابی
          </button>
          <button id="stopBtn" onclick="stopTracking()" disabled>
            🛑 توقف ردیابی
          </button>
          <button onclick="clearLogs()">🧹 پاک کردن لاگ‌ها</button>
        </div>
      </div>

      <div class="container">
        <h3>📋 لاگ تغییرات</h3>
        <div id="logs" class="logs">
          <div class="log-entry">آماده برای شروع ردیابی...</div>
        </div>
      </div>
    </div>

    <script type="module">
      // Enhanced Real-time Tracker Test Implementation
      class TestTracker {
        constructor() {
          this.isActive = false;
          this.startTime = 0;
          this.onlineTime = 0;
          this.offlineTime = 0;
          this.totalSwitches = 0;
          this.lastStatus = null;
          this.statusStartTime = 0;
          this.state = null;
          this.heartbeatInterval = null;

          // Bind event handlers
          this.handleVisibilityChange = this.handleVisibilityChange.bind(this);
          this.handleWindowFocus = this.handleWindowFocus.bind(this);
          this.handleWindowBlur = this.handleWindowBlur.bind(this);
          this.handleBeforeUnload = this.handleBeforeUnload.bind(this);
          this.handleUnload = this.handleUnload.bind(this);
          this.handleNetworkOnline = this.handleNetworkOnline.bind(this);
          this.handleNetworkOffline = this.handleNetworkOffline.bind(this);
          this.handleUserActivity = this.handleUserActivity.bind(this);
        }

        start() {
          if (this.isActive) return;

          this.log("🚀 شروع ردیابی Real-time", "change");
          this.isActive = true;
          this.startTime = Date.now();
          this.statusStartTime = Date.now();

          // Initialize state
          this.state = {
            isOnline: true,
            isInPage: true,
            lastSeen: Date.now(),
            browserTabActive: !document.hidden,
            networkConnected: navigator.onLine,
          };

          this.setupEventListeners();
          this.startHeartbeat();
          this.updateDisplay("شروع ردیابی");

          document.getElementById("startBtn").disabled = true;
          document.getElementById("stopBtn").disabled = false;
        }

        stop() {
          if (!this.isActive) return;

          this.log("🛑 توقف ردیابی Real-time", "change");

          // Mark as offline
          this.state.isOnline = false;
          this.state.isInPage = false;
          this.updateDisplay("توقف ردیابی");

          this.cleanup();

          document.getElementById("startBtn").disabled = false;
          document.getElementById("stopBtn").disabled = true;
        }

        setupEventListeners() {
          document.addEventListener(
            "visibilitychange",
            this.handleVisibilityChange,
            true,
          );
          window.addEventListener("focus", this.handleWindowFocus, true);
          window.addEventListener("blur", this.handleWindowBlur, true);
          window.addEventListener(
            "beforeunload",
            this.handleBeforeUnload,
            true,
          );
          window.addEventListener("unload", this.handleUnload, true);
          window.addEventListener("pagehide", this.handleUnload, true);
          window.addEventListener("online", this.handleNetworkOnline, true);
          window.addEventListener("offline", this.handleNetworkOffline, true);

          const activityEvents = [
            "click",
            "keydown",
            "mousemove",
            "scroll",
            "touchstart",
          ];
          activityEvents.forEach((event) => {
            window.addEventListener(event, this.handleUserActivity, true);
          });

          this.log("✅ Event listeners متصل شدند", "change");
        }

        removeEventListeners() {
          document.removeEventListener(
            "visibilitychange",
            this.handleVisibilityChange,
            true,
          );
          window.removeEventListener("focus", this.handleWindowFocus, true);
          window.removeEventListener("blur", this.handleWindowBlur, true);
          window.removeEventListener(
            "beforeunload",
            this.handleBeforeUnload,
            true,
          );
          window.removeEventListener("unload", this.handleUnload, true);
          window.removeEventListener("pagehide", this.handleUnload, true);
          window.removeEventListener("online", this.handleNetworkOnline, true);
          window.removeEventListener(
            "offline",
            this.handleNetworkOffline,
            true,
          );

          const activityEvents = [
            "click",
            "keydown",
            "mousemove",
            "scroll",
            "touchstart",
          ];
          activityEvents.forEach((event) => {
            window.removeEventListener(event, this.handleUserActivity, true);
          });

          this.log("🧹 Event listeners حذف شدند", "change");
        }

        startHeartbeat() {
          this.heartbeatInterval = setInterval(() => {
            if (this.isActive) {
              this.updateStats();
              this.checkConsistency();
            }
          }, 1000);
        }

        stopHeartbeat() {
          if (this.heartbeatInterval) {
            clearInterval(this.heartbeatInterval);
            this.heartbeatInterval = null;
          }
        }

        handleVisibilityChange() {
          if (!this.isActive) return;

          const isVisible = !document.hidden;
          this.log(
            `👁️ تغییر وضعیت نمایش: ${isVisible ? "نمایان" : "مخفی"}`,
            "change",
          );

          this.state.browserTabActive = isVisible;
          this.state.isOnline = isVisible && this.state.networkConnected;
          this.state.isInPage = this.state.isOnline;
          this.state.lastSeen = Date.now();

          this.updateDisplay("تغییر وضعیت نمایش");
        }

        handleWindowFocus() {
          if (!this.isActive) return;

          this.log("🎯 فوکوس روی پنجره", "online");

          this.state.browserTabActive = true;
          this.state.isOnline = this.state.networkConnected;
          this.state.isInPage = this.state.isOnline;
          this.state.lastSeen = Date.now();

          this.updateDisplay("فوکوس پنجره");
        }

        handleWindowBlur() {
          if (!this.isActive) return;

          this.log("😑 خروج فوکوس از پنجره", "offline");

          this.state.browserTabActive = false;
          this.state.isOnline = false;
          this.state.isInPage = false;
          this.state.lastSeen = Date.now();

          this.updateDisplay("خروج فوکوس");
        }

        handleBeforeUnload() {
          if (!this.isActive) return;

          this.log("⚠️ در حال خروج از صفحه...", "offline");

          this.state.isOnline = false;
          this.state.isInPage = false;
          this.state.lastSeen = Date.now();

          this.updateDisplay("خروج از صفحه");
        }

        handleUnload() {
          if (!this.isActive) return;

          this.log("🚫 صفحه بسته شد", "offline");

          this.state.isOnline = false;
          this.state.isInPage = false;

          this.updateDisplay("بستن صفحه");
          this.cleanup();
        }

        handleNetworkOnline() {
          if (!this.isActive) return;

          this.log("🌐 اتصال اینترنت برقرار شد", "online");

          this.state.networkConnected = true;
          if (this.state.browserTabActive) {
            this.state.isOnline = true;
            this.state.isInPage = true;
          }

          this.updateDisplay("اتصال اینترنت");
        }

        handleNetworkOffline() {
          if (!this.isActive) return;

          this.log("📴 اتصال اینترنت قطع شد", "offline");

          this.state.networkConnected = false;
          this.state.isOnline = false;
          this.state.isInPage = false;

          this.updateDisplay("قطع اینترنت");
        }

        handleUserActivity() {
          if (!this.isActive) return;

          this.state.lastSeen = Date.now();

          if (this.state.networkConnected && this.state.browserTabActive) {
            this.state.isOnline = true;
            this.state.isInPage = true;
          }
        }

        checkConsistency() {
          if (!this.state) return;

          const actuallyVisible = !document.hidden;
          const actuallyOnline = navigator.onLine;

          if (this.state.browserTabActive !== actuallyVisible) {
            this.log(
              `🔧 تصحیح وضعیت نمایش: ${this.state.browserTabActive} → ${actuallyVisible}`,
              "change",
            );
            this.state.browserTabActive = actuallyVisible;
          }

          if (this.state.networkConnected !== actuallyOnline) {
            this.log(
              `🔧 تصحیح وضعیت شبکه: ${this.state.networkConnected} → ${actuallyOnline}`,
              "change",
            );
            this.state.networkConnected = actuallyOnline;
          }

          const shouldBeOnline =
            this.state.browserTabActive && this.state.networkConnected;

          if (this.state.isOnline !== shouldBeOnline) {
            this.state.isOnline = shouldBeOnline;
            this.state.isInPage = shouldBeOnline;
            this.updateDisplay("تصحیح خودکار");
          }
        }

        updateDisplay(reason) {
          if (!this.state) return;

          const statusText = this.getStatusText();
          const statusEmoji = this.getStatusEmoji();
          const currentStatus = this.state.isOnline ? "online" : "offline";

          // Update status display
          const statusEl = document.getElementById("currentStatus");
          statusEl.textContent = `${statusEmoji} ${statusText}`;
          statusEl.className = `status ${currentStatus}`;

          // Update details
          document.getElementById("detailStatus").innerHTML = `
                <strong>در صفحه:</strong> ${this.state.isInPage ? "✅ بله" : "❌ خیر"}<br>
                <strong>تب فعال:</strong> ${this.state.browserTabActive ? "✅ بله" : "❌ خیر"}<br>
                <strong>شبکه متصل:</strong> ${this.state.networkConnected ? "✅ بله" : "❌ خیر"}<br>
                <strong>آخرین فعالیت:</strong> ${new Date(this.state.lastSeen).toLocaleTimeString("fa-IR")}
            `;

          // Count switches
          if (this.lastStatus !== null && this.lastStatus !== currentStatus) {
            this.totalSwitches++;
            this.updateStats();
          }

          if (this.lastStatus !== currentStatus) {
            this.lastStatus = currentStatus;
            this.statusStartTime = Date.now();
          }

          this.log(`${statusEmoji} ${statusText} (${reason})`, currentStatus);
        }

        updateStats() {
          const now = Date.now();
          const currentSessionTime = (now - this.statusStartTime) / 1000;

          if (this.lastStatus === "online") {
            this.onlineTime += 1;
          } else if (this.lastStatus === "offline") {
            this.offlineTime += 1;
          }

          document.getElementById("onlineTime").textContent =
            this.onlineTime.toString();
          document.getElementById("offlineTime").textContent =
            this.offlineTime.toString();
          document.getElementById("totalSwitches").textContent =
            this.totalSwitches.toString();
          document.getElementById("lastUpdate").textContent =
            new Date().toLocaleTimeString("fa-IR");
        }

        getStatusText() {
          if (!this.state) return "نامعلوم";

          if (!this.state.networkConnected) return "قطع اینترنت";
          if (!this.state.isOnline) return "آفلاین";
          if (!this.state.isInPage) return "آفلاین";
          if (!this.state.browserTabActive) return "آنلاین (تب غیرفعال)";

          return "آنلاین";
        }

        getStatusEmoji() {
          if (!this.state) return "❓";

          if (!this.state.networkConnected) return "📡";
          if (!this.state.isOnline || !this.state.isInPage) return "🔴";
          if (!this.state.browserTabActive) return "🟡";

          return "🟢";
        }

        log(message, type = "info") {
          const logsEl = document.getElementById("logs");
          const time = new Date().toLocaleTimeString("fa-IR");
          const logEntry = document.createElement("div");
          logEntry.className = `log-entry log-${type}`;
          logEntry.textContent = `[${time}] ${message}`;

          logsEl.appendChild(logEntry);
          logsEl.scrollTop = logsEl.scrollHeight;

          // Keep only last 50 logs
          const logs = logsEl.children;
          if (logs.length > 50) {
            logsEl.removeChild(logs[0]);
          }
        }

        cleanup() {
          this.isActive = false;
          this.stopHeartbeat();
          this.removeEventListeners();
          this.state = null;
        }
      }

      // Global instance
      const tracker = new TestTracker();

      // Global functions
      window.startTracking = () => tracker.start();
      window.stopTracking = () => tracker.stop();
      window.clearLogs = () => {
        document.getElementById("logs").innerHTML =
          '<div class="log-entry">لاگ‌ها پاک شدند...</div>';
      };

      // Auto-start tracking
      window.addEventListener("load", () => {
        tracker.start();
      });
    </script>
  </body>
</html>
