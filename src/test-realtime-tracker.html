<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø¢Ø²Ù…Ø§ÛŒØ´ Real-time Tracker</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        direction: rtl;
        text-align: right;
        background: #f5f7fa;
      }

      .container {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .status {
        font-size: 24px;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        font-weight: bold;
      }

      .online {
        background: #d4edda;
        color: #155724;
        border: 2px solid #c3e6cb;
      }

      .offline {
        background: #f8d7da;
        color: #721c24;
        border: 2px solid #f5c6cb;
      }

      .inactive {
        background: #fff3cd;
        color: #856404;
        border: 2px solid #ffeaa7;
      }

      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
      }

      .logs {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }

      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-radius: 4px;
      }

      .log-online {
        background: #d4edda;
      }

      .log-offline {
        background: #f8d7da;
      }

      .log-change {
        background: #fff3cd;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }

      button:hover {
        background: #0056b3;
      }

      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .stat {
        background: #e9ecef;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #495057;
      }

      .stat-label {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ§ª Ø¢Ø²Ù…Ø§ÛŒØ´ Ø³ÛŒØ³ØªÙ… Real-time Online/Offline</h1>

    <div class="info">
      <h3>ğŸ“ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¢Ø²Ù…Ø§ÛŒØ´</h3>
      <p>
        Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø³ÛŒØ³ØªÙ… ØªØ´Ø®ÛŒØµ Ø¢Ù†Ù„Ø§ÛŒÙ†/Ø¢ÙÙ„Ø§ÛŒÙ† Ø¨ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡. Ø¹Ù…Ù„ÛŒØ§Øª
        Ø²ÛŒØ± Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯:
      </p>
      <ul>
        <li>ğŸ”„ ØµÙØ­Ù‡ Ø±Ø§ reload Ú©Ù†ÛŒØ¯</li>
        <li>ğŸ” ØªØ¨ Ø±Ø§ Ø¹ÙˆØ¶ Ú©Ù†ÛŒØ¯</li>
        <li>âŒ ØµÙØ­Ù‡ Ø±Ø§ Ø¨Ø¨Ù†Ø¯ÛŒØ¯</li>
        <li>ğŸ“¡ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ Ù‚Ø·Ø¹/ÙˆØµÙ„ Ú©Ù†ÛŒØ¯</li>
        <li>ğŸ‘† Ø±ÙˆÛŒ ØµÙØ­Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø­Ø±Ú©Øª Ø¯Ù‡ÛŒØ¯</li>
      </ul>
    </div>

    <div class="grid">
      <div class="container">
        <h3>ğŸ“Š ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ</h3>

        <div id="currentStatus" class="status offline">
          â“ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...
        </div>

        <div class="stats">
          <div class="stat">
            <div id="onlineTime" class="stat-value">0</div>
            <div class="stat-label">Ø«Ø§Ù†ÛŒÙ‡ Ø¢Ù†Ù„Ø§ÛŒÙ†</div>
          </div>
          <div class="stat">
            <div id="offlineTime" class="stat-value">0</div>
            <div class="stat-label">Ø«Ø§Ù†ÛŒÙ‡ Ø¢ÙÙ„Ø§ÛŒÙ†</div>
          </div>
          <div class="stat">
            <div id="totalSwitches" class="stat-value">0</div>
            <div class="stat-label">ØªØ¹Ø¯Ø§Ø¯ ØªØºÛŒÛŒØ±Ø§Øª</div>
          </div>
          <div class="stat">
            <div id="lastUpdate" class="stat-value">-</div>
            <div class="stat-label">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</div>
          </div>
        </div>

        <div>
          <h4>Ø¬Ø²Ø¦ÛŒØ§Øª ÙˆØ¶Ø¹ÛŒØª:</h4>
          <p id="detailStatus">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
        </div>

        <div>
          <button id="startBtn" onclick="startTracking()">
            ğŸš€ Ø´Ø±ÙˆØ¹ Ø±Ø¯ÛŒØ§Ø¨ÛŒ
          </button>
          <button id="stopBtn" onclick="stopTracking()" disabled>
            ğŸ›‘ ØªÙˆÙ‚Ù Ø±Ø¯ÛŒØ§Ø¨ÛŒ
          </button>
          <button onclick="clearLogs()">ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÙ‡Ø§</button>
        </div>
      </div>

      <div class="container">
        <h3>ğŸ“‹ Ù„Ø§Ú¯ ØªØºÛŒÛŒØ±Ø§Øª</h3>
        <div id="logs" class="logs">
          <div class="log-entry">Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø±Ø¯ÛŒØ§Ø¨ÛŒ...</div>
        </div>
      </div>
    </div>

    <script type="module">
      // Enhanced Real-time Tracker Test Implementation
      class TestTracker {
        constructor() {
          this.isActive = false;
          this.startTime = 0;
          this.onlineTime = 0;
          this.offlineTime = 0;
          this.totalSwitches = 0;
          this.lastStatus = null;
          this.statusStartTime = 0;
          this.state = null;
          this.heartbeatInterval = null;

          // Bind event handlers
          this.handleVisibilityChange = this.handleVisibilityChange.bind(this);
          this.handleWindowFocus = this.handleWindowFocus.bind(this);
          this.handleWindowBlur = this.handleWindowBlur.bind(this);
          this.handleBeforeUnload = this.handleBeforeUnload.bind(this);
          this.handleUnload = this.handleUnload.bind(this);
          this.handleNetworkOnline = this.handleNetworkOnline.bind(this);
          this.handleNetworkOffline = this.handleNetworkOffline.bind(this);
          this.handleUserActivity = this.handleUserActivity.bind(this);
        }

        start() {
          if (this.isActive) return;

          this.log("ğŸš€ Ø´Ø±ÙˆØ¹ Ø±Ø¯ÛŒØ§Ø¨ÛŒ Real-time", "change");
          this.isActive = true;
          this.startTime = Date.now();
          this.statusStartTime = Date.now();

          // Initialize state
          this.state = {
            isOnline: true,
            isInPage: true,
            lastSeen: Date.now(),
            browserTabActive: !document.hidden,
            networkConnected: navigator.onLine,
          };

          this.setupEventListeners();
          this.startHeartbeat();
          this.updateDisplay("Ø´Ø±ÙˆØ¹ Ø±Ø¯ÛŒØ§Ø¨ÛŒ");

          document.getElementById("startBtn").disabled = true;
          document.getElementById("stopBtn").disabled = false;
        }

        stop() {
          if (!this.isActive) return;

          this.log("ğŸ›‘ ØªÙˆÙ‚Ù Ø±Ø¯ÛŒØ§Ø¨ÛŒ Real-time", "change");

          // Mark as offline
          this.state.isOnline = false;
          this.state.isInPage = false;
          this.updateDisplay("ØªÙˆÙ‚Ù Ø±Ø¯ÛŒØ§Ø¨ÛŒ");

          this.cleanup();

          document.getElementById("startBtn").disabled = false;
          document.getElementById("stopBtn").disabled = true;
        }

        setupEventListeners() {
          document.addEventListener(
            "visibilitychange",
            this.handleVisibilityChange,
            true,
          );
          window.addEventListener("focus", this.handleWindowFocus, true);
          window.addEventListener("blur", this.handleWindowBlur, true);
          window.addEventListener(
            "beforeunload",
            this.handleBeforeUnload,
            true,
          );
          window.addEventListener("unload", this.handleUnload, true);
          window.addEventListener("pagehide", this.handleUnload, true);
          window.addEventListener("online", this.handleNetworkOnline, true);
          window.addEventListener("offline", this.handleNetworkOffline, true);

          const activityEvents = [
            "click",
            "keydown",
            "mousemove",
            "scroll",
            "touchstart",
          ];
          activityEvents.forEach((event) => {
            window.addEventListener(event, this.handleUserActivity, true);
          });

          this.log("âœ… Event listeners Ù…ØªØµÙ„ Ø´Ø¯Ù†Ø¯", "change");
        }

        removeEventListeners() {
          document.removeEventListener(
            "visibilitychange",
            this.handleVisibilityChange,
            true,
          );
          window.removeEventListener("focus", this.handleWindowFocus, true);
          window.removeEventListener("blur", this.handleWindowBlur, true);
          window.removeEventListener(
            "beforeunload",
            this.handleBeforeUnload,
            true,
          );
          window.removeEventListener("unload", this.handleUnload, true);
          window.removeEventListener("pagehide", this.handleUnload, true);
          window.removeEventListener("online", this.handleNetworkOnline, true);
          window.removeEventListener(
            "offline",
            this.handleNetworkOffline,
            true,
          );

          const activityEvents = [
            "click",
            "keydown",
            "mousemove",
            "scroll",
            "touchstart",
          ];
          activityEvents.forEach((event) => {
            window.removeEventListener(event, this.handleUserActivity, true);
          });

          this.log("ğŸ§¹ Event listeners Ø­Ø°Ù Ø´Ø¯Ù†Ø¯", "change");
        }

        startHeartbeat() {
          this.heartbeatInterval = setInterval(() => {
            if (this.isActive) {
              this.updateStats();
              this.checkConsistency();
            }
          }, 1000);
        }

        stopHeartbeat() {
          if (this.heartbeatInterval) {
            clearInterval(this.heartbeatInterval);
            this.heartbeatInterval = null;
          }
        }

        handleVisibilityChange() {
          if (!this.isActive) return;

          const isVisible = !document.hidden;
          this.log(
            `ğŸ‘ï¸ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ù†Ù…Ø§ÛŒØ´: ${isVisible ? "Ù†Ù…Ø§ÛŒØ§Ù†" : "Ù…Ø®ÙÛŒ"}`,
            "change",
          );

          this.state.browserTabActive = isVisible;
          this.state.isOnline = isVisible && this.state.networkConnected;
          this.state.isInPage = this.state.isOnline;
          this.state.lastSeen = Date.now();

          this.updateDisplay("ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ù†Ù…Ø§ÛŒØ´");
        }

        handleWindowFocus() {
          if (!this.isActive) return;

          this.log("ğŸ¯ ÙÙˆÚ©ÙˆØ³ Ø±ÙˆÛŒ Ù¾Ù†Ø¬Ø±Ù‡", "online");

          this.state.browserTabActive = true;
          this.state.isOnline = this.state.networkConnected;
          this.state.isInPage = this.state.isOnline;
          this.state.lastSeen = Date.now();

          this.updateDisplay("ÙÙˆÚ©ÙˆØ³ Ù¾Ù†Ø¬Ø±Ù‡");
        }

        handleWindowBlur() {
          if (!this.isActive) return;

          this.log("ğŸ˜‘ Ø®Ø±ÙˆØ¬ ÙÙˆÚ©ÙˆØ³ Ø§Ø² Ù¾Ù†Ø¬Ø±Ù‡", "offline");

          this.state.browserTabActive = false;
          this.state.isOnline = false;
          this.state.isInPage = false;
          this.state.lastSeen = Date.now();

          this.updateDisplay("Ø®Ø±ÙˆØ¬ ÙÙˆÚ©ÙˆØ³");
        }

        handleBeforeUnload() {
          if (!this.isActive) return;

          this.log("âš ï¸ Ø¯Ø± Ø­Ø§Ù„ Ø®Ø±ÙˆØ¬ Ø§Ø² ØµÙØ­Ù‡...", "offline");

          this.state.isOnline = false;
          this.state.isInPage = false;
          this.state.lastSeen = Date.now();

          this.updateDisplay("Ø®Ø±ÙˆØ¬ Ø§Ø² ØµÙØ­Ù‡");
        }

        handleUnload() {
          if (!this.isActive) return;

          this.log("ğŸš« ØµÙØ­Ù‡ Ø¨Ø³ØªÙ‡ Ø´Ø¯", "offline");

          this.state.isOnline = false;
          this.state.isInPage = false;

          this.updateDisplay("Ø¨Ø³ØªÙ† ØµÙØ­Ù‡");
          this.cleanup();
        }

        handleNetworkOnline() {
          if (!this.isActive) return;

          this.log("ğŸŒ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯", "online");

          this.state.networkConnected = true;
          if (this.state.browserTabActive) {
            this.state.isOnline = true;
            this.state.isInPage = true;
          }

          this.updateDisplay("Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª");
        }

        handleNetworkOffline() {
          if (!this.isActive) return;

          this.log("ğŸ“´ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ù‚Ø·Ø¹ Ø´Ø¯", "offline");

          this.state.networkConnected = false;
          this.state.isOnline = false;
          this.state.isInPage = false;

          this.updateDisplay("Ù‚Ø·Ø¹ Ø§ÛŒÙ†ØªØ±Ù†Øª");
        }

        handleUserActivity() {
          if (!this.isActive) return;

          this.state.lastSeen = Date.now();

          if (this.state.networkConnected && this.state.browserTabActive) {
            this.state.isOnline = true;
            this.state.isInPage = true;
          }
        }

        checkConsistency() {
          if (!this.state) return;

          const actuallyVisible = !document.hidden;
          const actuallyOnline = navigator.onLine;

          if (this.state.browserTabActive !== actuallyVisible) {
            this.log(
              `ğŸ”§ ØªØµØ­ÛŒØ­ ÙˆØ¶Ø¹ÛŒØª Ù†Ù…Ø§ÛŒØ´: ${this.state.browserTabActive} â†’ ${actuallyVisible}`,
              "change",
            );
            this.state.browserTabActive = actuallyVisible;
          }

          if (this.state.networkConnected !== actuallyOnline) {
            this.log(
              `ğŸ”§ ØªØµØ­ÛŒØ­ ÙˆØ¶Ø¹ÛŒØª Ø´Ø¨Ú©Ù‡: ${this.state.networkConnected} â†’ ${actuallyOnline}`,
              "change",
            );
            this.state.networkConnected = actuallyOnline;
          }

          const shouldBeOnline =
            this.state.browserTabActive && this.state.networkConnected;

          if (this.state.isOnline !== shouldBeOnline) {
            this.state.isOnline = shouldBeOnline;
            this.state.isInPage = shouldBeOnline;
            this.updateDisplay("ØªØµØ­ÛŒØ­ Ø®ÙˆØ¯Ú©Ø§Ø±");
          }
        }

        updateDisplay(reason) {
          if (!this.state) return;

          const statusText = this.getStatusText();
          const statusEmoji = this.getStatusEmoji();
          const currentStatus = this.state.isOnline ? "online" : "offline";

          // Update status display
          const statusEl = document.getElementById("currentStatus");
          statusEl.textContent = `${statusEmoji} ${statusText}`;
          statusEl.className = `status ${currentStatus}`;

          // Update details
          document.getElementById("detailStatus").innerHTML = `
                <strong>Ø¯Ø± ØµÙØ­Ù‡:</strong> ${this.state.isInPage ? "âœ… Ø¨Ù„Ù‡" : "âŒ Ø®ÛŒØ±"}<br>
                <strong>ØªØ¨ ÙØ¹Ø§Ù„:</strong> ${this.state.browserTabActive ? "âœ… Ø¨Ù„Ù‡" : "âŒ Ø®ÛŒØ±"}<br>
                <strong>Ø´Ø¨Ú©Ù‡ Ù…ØªØµÙ„:</strong> ${this.state.networkConnected ? "âœ… Ø¨Ù„Ù‡" : "âŒ Ø®ÛŒØ±"}<br>
                <strong>Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª:</strong> ${new Date(this.state.lastSeen).toLocaleTimeString("fa-IR")}
            `;

          // Count switches
          if (this.lastStatus !== null && this.lastStatus !== currentStatus) {
            this.totalSwitches++;
            this.updateStats();
          }

          if (this.lastStatus !== currentStatus) {
            this.lastStatus = currentStatus;
            this.statusStartTime = Date.now();
          }

          this.log(`${statusEmoji} ${statusText} (${reason})`, currentStatus);
        }

        updateStats() {
          const now = Date.now();
          const currentSessionTime = (now - this.statusStartTime) / 1000;

          if (this.lastStatus === "online") {
            this.onlineTime += 1;
          } else if (this.lastStatus === "offline") {
            this.offlineTime += 1;
          }

          document.getElementById("onlineTime").textContent =
            this.onlineTime.toString();
          document.getElementById("offlineTime").textContent =
            this.offlineTime.toString();
          document.getElementById("totalSwitches").textContent =
            this.totalSwitches.toString();
          document.getElementById("lastUpdate").textContent =
            new Date().toLocaleTimeString("fa-IR");
        }

        getStatusText() {
          if (!this.state) return "Ù†Ø§Ù…Ø¹Ù„ÙˆÙ…";

          if (!this.state.networkConnected) return "Ù‚Ø·Ø¹ Ø§ÛŒÙ†ØªØ±Ù†Øª";
          if (!this.state.isOnline) return "Ø¢ÙÙ„Ø§ÛŒÙ†";
          if (!this.state.isInPage) return "Ø¢ÙÙ„Ø§ÛŒÙ†";
          if (!this.state.browserTabActive) return "Ø¢Ù†Ù„Ø§ÛŒÙ† (ØªØ¨ ØºÛŒØ±ÙØ¹Ø§Ù„)";

          return "Ø¢Ù†Ù„Ø§ÛŒÙ†";
        }

        getStatusEmoji() {
          if (!this.state) return "â“";

          if (!this.state.networkConnected) return "ğŸ“¡";
          if (!this.state.isOnline || !this.state.isInPage) return "ğŸ”´";
          if (!this.state.browserTabActive) return "ğŸŸ¡";

          return "ğŸŸ¢";
        }

        log(message, type = "info") {
          const logsEl = document.getElementById("logs");
          const time = new Date().toLocaleTimeString("fa-IR");
          const logEntry = document.createElement("div");
          logEntry.className = `log-entry log-${type}`;
          logEntry.textContent = `[${time}] ${message}`;

          logsEl.appendChild(logEntry);
          logsEl.scrollTop = logsEl.scrollHeight;

          // Keep only last 50 logs
          const logs = logsEl.children;
          if (logs.length > 50) {
            logsEl.removeChild(logs[0]);
          }
        }

        cleanup() {
          this.isActive = false;
          this.stopHeartbeat();
          this.removeEventListeners();
          this.state = null;
        }
      }

      // Global instance
      const tracker = new TestTracker();

      // Global functions
      window.startTracking = () => tracker.start();
      window.stopTracking = () => tracker.stop();
      window.clearLogs = () => {
        document.getElementById("logs").innerHTML =
          '<div class="log-entry">Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯...</div>';
      };

      // Auto-start tracking
      window.addEventListener("load", () => {
        tracker.start();
      });
    </script>
  </body>
</html>
